<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monty Mart</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  --bg: #f3f7fb;
  --text: #1c2b3a;
  --muted: #5b6f82;
  --panel: #ffffffd9;
  --line: #d7e2ec;
  --brand: #0f7bb8;
  --brand-dark: #0b5f8d;
  --accent: #ff9f45;
  --shadow: 0 12px 30px rgba(35, 56, 80, 0.13);
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Manrope", sans-serif;
  color: var(--text);
  background:
    radial-gradient(circle at 12% 12%, #ffdcb7 0%, transparent 30%),
    radial-gradient(circle at 88% 18%, #cfe8ff 0%, transparent 34%),
    linear-gradient(160deg, #f4f8ff 0%, #edf7f8 46%, #fff4e5 100%);
  min-height: 100vh;
}
h2 {
  font-family: "Space Grotesk", sans-serif;
  letter-spacing: 0.2px;
  margin: 22px 0 12px;
}
header {
  position: sticky;
  top: 0;
  z-index: 40;
  text-align: center;
  padding: 16px 14px;
  color: #f7fff9;
  font-family: "Space Grotesk", sans-serif;
  font-size: 24px;
  letter-spacing: 0.6px;
  background: linear-gradient(96deg, #12406b, #0f6ea2 55%, #12919f);
  box-shadow: 0 6px 20px rgba(14, 42, 73, 0.3);
}
.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 16px;
  padding: 16px;
}
.card {
  background: var(--panel);
  backdrop-filter: blur(4px);
  border: 1px solid #ffffff;
  padding: 12px;
  border-radius: 16px;
  text-align: center;
  box-shadow: var(--shadow);
  transform: translateY(0);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  animation: riseIn 0.4s ease both;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 16px 30px rgba(34, 55, 44, 0.22);
}
.card img {
  width: 100%;
  height: 146px;
  object-fit: contain;
  background: #ffffff;
  border-radius: 10px;
  border: 1px solid #edf3e6;
}
.card h3 {
  margin: 10px 0 6px;
  font-family: "Space Grotesk", sans-serif;
  font-size: 18px;
}
.price { font-weight: 800; margin: 7px 0; color: #0f5680; }
.stock { font-size: 14px; margin-bottom: 6px; color: #29465f; }
.weight { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
.btn {
  background: linear-gradient(135deg, var(--brand), #36a5d8);
  color: #fff;
  padding: 10px 14px;
  border: none;
  border-radius: 9px;
  cursor: pointer;
  margin-top: 6px;
  font-weight: 700;
  letter-spacing: 0.2px;
  box-shadow: 0 10px 16px rgba(14, 101, 151, 0.26);
  transition: transform 0.16s ease, filter 0.16s ease;
}
.btn:hover { filter: brightness(1.04); transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.infoBar {
  margin: 10px 14px 0;
  border: 1px solid #d8e7f4;
  border-radius: 10px;
  background: #f3fbff;
  padding: 8px 10px;
  text-align: center;
}
.deliveryNote { font-size: 13px; color: #28485f; margin-top: 8px; font-weight: 600; }
#closedOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #cc2b2b;
  color: #fff;
  z-index: 999;
  text-align: center;
  padding: 10px;
  font-size: 18px;
  font-weight: 800;
}
#storeStatus {
  text-align: center;
  padding: 9px 8px;
  background: #e3f1ff;
  color: #194f75;
  font-weight: 700;
  border-bottom: 1px solid #c8deef;
}
#cart {
  text-align: center;
  margin: 0 14px;
  background: var(--panel);
  border: 1px solid #ffffff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: var(--shadow);
}
#adminPanel {
  display: none;
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 12px;
  margin: 10px 14px 0;
  text-align: left;
  background: #fffef7;
  box-shadow: var(--shadow);
}
#billBox {
  position: fixed;
  left: -9999px;
  top: 0;
  opacity: 0;
  background: #fff;
  padding: 15px;
  font-family: monospace;
  width: 280px;
  border: 1px solid #000;
}
input, select {
  width: min(310px, 90vw);
  padding: 10px 11px;
  border: 1px solid #c7d9ea;
  border-radius: 10px;
  margin-bottom: 8px;
  background: #fbfdff;
  font-family: "Manrope", sans-serif;
  font-size: 14px;
}
input[type="number"] {
  width: 74px;
  padding: 8px;
  margin-bottom: 6px;
  text-align: center;
}
input:focus, select:focus {
  outline: 2px solid #9fcaea;
  outline-offset: 1px;
  border-color: #4d94c8;
}
#liveOrdersGrid { display: grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap: 10px; align-items: start; }
.floorCol { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 8px; min-height: 220px; }
.floorTitle { font-weight: 800; margin-bottom: 6px; font-family: "Space Grotesk", sans-serif; }
.floorMeta { font-size: 12px; color: #56685e; margin-bottom: 8px; }
.floorOrdersList { max-height: 72vh; overflow-y: auto; padding-right: 4px; }
.stockEditorRow { margin-bottom: 6px; }
.priceGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.priceCol { border: 1px solid var(--line); border-radius: 10px; padding: 8px; background: #fafdf8; }
.priceCol h4 { margin: 0 0 8px 0; }
.distGrid { display: grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap: 10px; margin-top: 8px; }
.distCol { border: 1px solid var(--line); border-radius: 10px; background: #fafdf8; padding: 8px; }
.distCol h4 { margin: 0 0 8px 0; }
.qrPaymentBox {
  max-width: 360px;
  margin: 12px auto 0 auto;
  background: #f1f9ff;
  border: 1px solid #d1e4f3;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 6px 14px rgba(26, 88, 130, 0.13);
}
.qrPaymentBox h4 {
  margin: 0 0 8px 0;
  color: #125f8f;
  font-family: "Space Grotesk", sans-serif;
}
.qrPaymentBox img {
  width: 180px;
  height: 180px;
  object-fit: contain;
  border: 1px solid #dceada;
  border-radius: 8px;
  background: #fff;
}
.qrPaymentHint {
  font-size: 13px;
  color: #2a4d68;
  margin-top: 8px;
  font-weight: 600;
}
@keyframes riseIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
@media (max-width: 768px) {
  header { font-size: 21px; }
  .priceGrid { grid-template-columns: 1fr; }
  .distGrid { grid-template-columns: 1fr; }
  .container { padding: 12px; gap: 12px; }
  #cart, #adminPanel, .infoBar { margin-left: 10px; margin-right: 10px; }
}
@media (max-width: 480px) {
  h2 { font-size: 21px; }
  header { padding: 14px 10px; font-size: 19px; }
  .container { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
  .card { padding: 10px; border-radius: 12px; }
  .card img { height: 118px; }
  .card h3 { font-size: 16px; }
  .btn { width: 100%; padding: 10px 8px; }
  input, select { width: min(320px, 94vw); }
  .qrPaymentBox { max-width: 94vw; }
}
@media (max-width: 1024px) {
  #liveOrdersGrid { grid-template-columns: 1fr; }
  .floorOrdersList { max-height: 45vh; }
}
</style>
</head>
<body>

<header id="storeHeader">My Hostel Store</header>
<audio id="orderAlertAudio" preload="auto">
  <source src="notification.mp3" type="audio/mpeg">
  <source src="notification.wav" type="audio/wav">
</audio>
<div id="closedOverlay">STORE IS CLOSED - Orders Disabled</div>
<div id="storeStatus">STORE OPEN</div>
<div id="topCustomersBox" class="infoBar">Top 3 Customers (This Month): Loading...</div>

<h2 style="text-align:center;">Customer Details</h2>
<div style="text-align:center; margin-bottom:20px;">
  <input id="custName" placeholder="Your Name"><br>
  <input id="roomNo" placeholder="Room Number (3 digits)" inputmode="numeric" maxlength="3" pattern="[0-9]{3}"><br>

  <select id="mode">
    <option value="delivery">Room Delivery</option>
    <option value="pickup">Self Pickup</option>
  </select><br>
  <select id="paymentMode">
    <option value="cash">Cash</option>
    <option value="upi">Online (UPI)</option>
  </select><br>

  <div id="deliveryNote" class="deliveryNote">Delivery Charges: Rs 10 (Room Delivery)</div>
</div>

<div class="container">
  <div class="card" data-name="Maggi" data-temp-unavailable="true">
    <img src="maggi.jpg" alt="Maggi">
    <h3>Maggi</h3>
    <div class="weight">70g Pack</div>
    <div class="price">Rs 20</div>
    <div class="stock" style="color:#dc3545;font-weight:700;">Temporarily Unavailable</div>
    <div style="font-size:12px;color:#dc3545;font-weight:700;margin-bottom:6px;">Out of Stock</div>
    <button class="btn" style="background:#dc3545;cursor:not-allowed;" disabled>Temporarily Unavailable</button>
  </div>

  <div class="card" data-name="Kurkure" data-temp-unavailable="true">
    <img src="kurkure.jpg" alt="Kurkure">
    <h3>Kurkure</h3>
    <div class="weight">75g Pack</div>
    <div class="price">Rs 20</div>
    <div class="stock" style="color:#dc3545;font-weight:700;">Temporarily Unavailable</div>
    <div style="font-size:12px;color:#dc3545;font-weight:700;margin-bottom:6px;">Out of Stock</div>
    <button class="btn" style="background:#dc3545;cursor:not-allowed;" disabled>Temporarily Unavailable</button>
  </div>

  <div class="card" data-name="Bhoot Chips" data-temp-unavailable="true">
    <img src="bhoot.png" alt="Bhoot Chips">
    <h3>Bhoot Chips</h3>
    <div class="weight">45g Pack</div>
    <div class="price">Rs 20</div>
    <div class="stock" style="color:#dc3545;font-weight:700;">Temporarily Unavailable</div>
    <div style="font-size:12px;color:#dc3545;font-weight:700;margin-bottom:6px;">Out of Stock</div>
    <button class="btn" style="background:#e6a9af;cursor:not-allowed;" disabled>Temporarily Unavailable</button>
  </div>

  <div class="card" data-name="Onion Chips">
    <img src="onion-chips.jfif" alt="Onion Chips">
    <h3>Onion Chips</h3>
    <div class="weight">80g Pack</div>
    <div class="price">Rs 30</div>
    <div class="stock"></div>
    <input type="number" id="qty7" value="1" min="1"><br>
    <button class="btn" onclick="addToCart(this, 30, 'qty7')">Add</button>
  </div>

  <div class="card" data-name="Unibic Chocolate Chip Cookies">
    <img src="unibic.jpg" alt="Unibic Chocolate Chip Cookies">
    <h3>Unibic Chocolate Chip Cookies</h3>
    <div class="weight">68g Pack</div>
    <div class="price">Rs 30</div>
    <div class="stock"></div>
    <input type="number" id="qty8" value="1" min="1"><br>
    <button class="btn" onclick="addToCart(this, 30, 'qty8')">Add</button>
  </div>

  <div class="card" data-name="Bhujia">
    <img src="bhujia.jpg" alt="Bhujia">
    <h3>Bhujia</h3>
    <div class="weight">1kg Pack</div>
    <div class="price">Rs 300</div>
    <div class="stock"></div>
    <input type="number" id="qty3" value="1" min="1"><br>
    <button class="btn" onclick="addToCart(this, 300, 'qty3')">Add</button>
  </div>

  <div class="card" data-name="Namkeen">
    <img src="namkeen.jpg" alt="Namkeen">
    <h3>Namkeen</h3>
    <div class="weight">150g Pack</div>
    <div class="price">Rs 50</div>
    <div class="stock"></div>
    <input type="number" id="qty9" value="1" min="1"><br>
    <button class="btn" onclick="addToCart(this, 50, 'qty9')">Add</button>
  </div>

</div>

<h2 style="text-align:center;">Cart</h2>
<div id="cart"></div>

<div style="text-align:center; margin:20px;">
  <button class="btn" onclick="placeOrder()">Place Order + Pay</button>
  <div id="cancelNote" style="font-size:13px;color:#d9534f;margin-top:8px;">Order cancel allowed only in 2 minutes</div>
  <div class="qrPaymentBox">
    <h4>Scan & Pay</h4>
    <img src="payment-qr.png" alt="Monty Mart QR Payment">
    <div class="qrPaymentHint">UPI ID: monty291@ptyes </div>
    <div class="qrPaymentHint">Mobile: 9983729301</div>
  </div>
  <div id="cancelOrderWrap" style="margin-top:8px;display:none;">
    <div id="cancelOrdersList" style="margin-bottom:6px;"></div>
    <div id="cancelTimerText" style="font-size:13px;margin-top:4px;"></div>
  </div>
  <div id="waManualWrap" style="display:none;margin-top:8px;font-size:13px;">
    WhatsApp did not open automatically.
    <a id="waManualLink" href="#" target="_blank" rel="noopener noreferrer">Tap to open WhatsApp message</a>
  </div>
  <div id="payManualWrap" style="display:none;margin-top:8px;font-size:13px;">
    Payment app did not open automatically.
    <a id="payManualLink" href="#">Tap to open payment app</a>
  </div>
  <div id="billManualWrap" style="display:none;margin-top:8px;font-size:13px;">
    Bill auto-download blocked. <a id="billManualLink" href="#" download="bill.png">Tap to download bill</a>
  </div>
</div>

<div style="text-align:center; margin-top:30px;">
  <button id="adminBtn" onclick="showAdmin()" style="display:none;">Admin</button>

  <div id="adminPanel">
    <h3>Admin</h3>
    <button onclick="enableOrderSound()">Enable Order Alert Sound</button>
    <div style="margin-top:8px;">This Device ID: <b id="deviceIdBox">-</b></div>
    <div id="earningsBox">Today Earnings: Rs 0</div>
    <div id="monthEarningsBox">This Month Earning: Rs 0</div>
    <div id="lowStockBox">Low Stock: None</div>
    <div id="ordersList"></div>

    <h4 style="margin:10px 0 6px 0;">Stock Entry</h4>
    <div class="stockEditorRow">Maggi <input id="sMaggi" type="number"></div>
    <div class="stockEditorRow">Kurkure <input id="sKurkure" type="number"></div>
    <div class="stockEditorRow">Bhujia <input id="sBhujia" type="number"></div>
    <div class="stockEditorRow">Namkeen <input id="sNamkeen" type="number"></div>
    <div class="stockEditorRow">Bhoot Chips <input id="sBhootChips" type="number"></div>
    <div class="stockEditorRow">Onion Chips <input id="sOnionChips" type="number"></div>
    <div class="stockEditorRow">Unibic Chocolate Chip Cookies <input id="sUnibicCookies" type="number"></div>

    <button onclick="saveStock()">Save Stock</button>
    <button onclick="showReport()">Today Report</button>
    <button onclick="toggleStore()">Open/Close</button>

    <hr>
    <button onclick="loadOrders()">Show Live Orders</button>
    <div id="liveOrders" style="margin-top:10px;"></div>
    <hr>
    <h3>All Customers (This Month)</h3>
    <button onclick="loadAdminCustomersReport()">Load Customer Spending</button>
    <button onclick="resetCustomerMoney()" style="background:#d9534f;color:#fff;">Reset Customer Money</button>
    <div id="adminCustomersReport" style="margin-top:10px;"></div>
    <h3>All-Time Customer Spending (Never Reset)</h3>
    <button onclick="loadLifetimeCustomersReport()">Load Lifetime Spending</button>
    <div id="lifetimeCustomersReport" style="margin-top:10px;"></div>

    <h3>Purchase/Sell Price (Profit)</h3>
    <div class="priceGrid">
      <div class="priceCol">
        <h4>Buy Price (Left)</h4>
        <div class="stockEditorRow">Maggi Buy Rs <input id="bMaggi" type="number"></div>
        <div class="stockEditorRow">Kurkure Buy Rs <input id="bKurkure" type="number"></div>
        <div class="stockEditorRow">Bhujia Buy Rs <input id="bBhujia" type="number"></div>
        <div class="stockEditorRow">Namkeen Buy Rs <input id="bNamkeen" type="number"></div>
        <div class="stockEditorRow">Bhoot Chips Buy Rs <input id="bBhootChips" type="number"></div>
        <div class="stockEditorRow">Onion Chips Buy Rs <input id="bOnionChips" type="number"></div>
        <div class="stockEditorRow">Unibic Cookies Buy Rs <input id="bUnibicCookies" type="number"></div>
        <button onclick="saveBuyPrice()">Save Buy Price</button>
      </div>
      <div class="priceCol">
        <h4>Sell Price (Right)</h4>
        <div class="stockEditorRow">Maggi Sell Rs <input id="spMaggi" type="number"></div>
        <div class="stockEditorRow">Kurkure Sell Rs <input id="spKurkure" type="number"></div>
        <div class="stockEditorRow">Bhujia Sell Rs <input id="spBhujia" type="number"></div>
        <div class="stockEditorRow">Namkeen Sell Rs <input id="spNamkeen" type="number"></div>
        <div class="stockEditorRow">Bhoot Chips Sell Rs <input id="spBhootChips" type="number"></div>
        <div class="stockEditorRow">Onion Chips Sell Rs <input id="spOnionChips" type="number"></div>
        <div class="stockEditorRow">Unibic Cookies Sell Rs <input id="spUnibicCookies" type="number"></div>
        <button onclick="saveSellPrice()">Save Sell Price</button>
      </div>
    </div>

    <div style="font-size:12px;color:#666;margin-top:6px;">Buy/Sell price save karne ke liye password required hai.</div>
    <div id="profitBox">Today Profit: Rs 0</div>
    <div id="monthProfitBox">This Month Profit: Rs 0</div>
    <button onclick="resetProfitTotals()" style="background:#d9534f;color:#fff;margin-top:8px;">Reset Profit</button>
  </div>
</div>

<div id="billBox">
  <h3 style="text-align:center; margin:0;">HOSTEL STORE</h3>
  <hr>
  <div id="billContent"></div>
  <hr>
  <div style="text-align:center;">Thank You</div>
</div>

<script>
let realPrice = {
  Maggi: 20,
  Kurkure: 20,
  Bhujia: 300,
  Namkeen: 50,
  "Bhoot Chips": 20,
  "Onion Chips": 30,
  "Unibic Chocolate Chip Cookies": 30
};

const DEFAULT_WHATSAPP_PHONE = "9983729301";
const STORE_UPI_ID = "monty291@ptyes";
const STORE_UPI_NAME = "Monty Mart";
const DEPLOYED_API_BASE = "https://happy-store-zxir.onrender.com";
let cart = [];
let stockData = {};
let storeClosed = false;
let orderCounter = parseInt(localStorage.getItem("orderNo") || "1001", 10);
let lastSeenOrderId = null;
let lastSeenOrderCount = 0;
let ACTIVE_API_BASE = null;
const LIVE_ORDERS_PER_FLOOR_LIMIT = 2000;

const DEVICE_ID_KEY = "mm_device_id";
const SOUND_ENABLED_KEY = "mm_sound_enabled";
const ALERT_ALLOWED_EXTRA_KEY = "mm_alert_allowed_extra_ids";
// Replace these with your actual allowed device IDs (laptop + one mobile).
const ORDER_ALERT_ALLOWED_DEVICE_IDS = [
  "MM-45SHVENV",
  "PUT_YOUR_MOBILE_DEVICE_ID_HERE"
];
const LAST_ORDER_ID_KEY = "mm_last_order_id";
const LAST_ORDER_TIME_KEY = "mm_last_order_time";
const RECENT_CANCEL_ORDERS_KEY = "mm_recent_cancel_orders";
const CANCEL_WINDOW_MS = 120000;
const ADMIN_TAP_TARGET = 5;
const ADMIN_TAP_WINDOW_MS = 6000;
const LOW_STOCK_THRESHOLD = 15;
const DISTRIBUTOR_LOW_STOCK_THRESHOLD = 10;
const DISTRIBUTOR_STOCK_CACHE_KEY = "mm_distributor_stock_cache";
let adminTapCount = 0;
let adminTapResetTimer = null;
let cancelUiTimer = null;

function readRecentCancelableOrders() {
  try {
    const raw = localStorage.getItem(RECENT_CANCEL_ORDERS_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(parsed)) return [];
    return parsed
      .map((o) => ({ id: Number(o && o.id), time: Number(o && o.time) }))
      .filter((o) => Number.isFinite(o.id) && o.id > 0 && Number.isFinite(o.time) && o.time > 0);
  } catch (_e) {
    return [];
  }
}

function writeRecentCancelableOrders(list) {
  if (!Array.isArray(list) || list.length === 0) {
    localStorage.removeItem(RECENT_CANCEL_ORDERS_KEY);
    return;
  }
  localStorage.setItem(RECENT_CANCEL_ORDERS_KEY, JSON.stringify(list));
}

function getActiveCancelableOrders() {
  const now = Date.now();
  const active = readRecentCancelableOrders()
    .filter((o) => (now - o.time) <= CANCEL_WINDOW_MS)
    .sort((a, b) => b.time - a.time);
  writeRecentCancelableOrders(active);
  return active;
}

function addRecentCancelableOrder(orderId, orderTime) {
  const list = getActiveCancelableOrders().filter((o) => o.id !== Number(orderId));
  list.unshift({ id: Number(orderId), time: Number(orderTime) });
  writeRecentCancelableOrders(list);
}

function removeRecentCancelableOrder(orderId) {
  const list = readRecentCancelableOrders().filter((o) => o.id !== Number(orderId));
  writeRecentCancelableOrders(list);
}

function getApiCandidates() {
  const list = [];
  const origin = window.location.origin;
  const host = window.location.hostname || "localhost";
  const isRenderHosted = /onrender\.com$/i.test(host);

  if (isRenderHosted) {
    // On deployed site always prefer deployed backend, not local laptop server.
    if (origin && origin.startsWith("http")) list.push(origin);
    list.push(DEPLOYED_API_BASE);
  } else {
    // Local development preference.
    list.push("http://localhost:5000");
    list.push(`http://${host}:5000`);
    if (origin && origin.startsWith("http")) list.push(origin);
    list.push(DEPLOYED_API_BASE);
  }

  // Deduplicate while preserving order
  return [...new Set(list)];
}

function triggerBillDownload(dataUrl, fileName) {
  setBillManualLink(dataUrl, fileName);

  const link = document.createElement("a");
  link.download = fileName;
  link.href = dataUrl;
  document.body.appendChild(link);
  link.click();
  link.remove();

  // Open preview so user can long-press/save even if download is blocked.
  if (isMobileDevice()) {
    try { window.open(dataUrl, "_blank"); } catch (_e) {}
  }
}

function buildTextBillDataUrl(text) {
  const canvas = document.createElement("canvas");
  const width = 1000;
  const paddingX = 50;
  const maxTextWidth = width - paddingX * 2;

  canvas.width = width;
  const ctx = canvas.getContext("2d");

  const rawLines = String(text || "").replace(/\r/g, "").split("\n");
  const bodyFont = "46px 'Courier New', monospace";
  ctx.font = bodyFont;

  const renderedLines = [];
  rawLines.forEach((line) => {
    const t = String(line || "");
    if (!t.trim()) {
      renderedLines.push("");
      return;
    }
    const words = t.split(" ");
    let current = "";
    words.forEach((word) => {
      const next = current ? `${current} ${word}` : word;
      if (ctx.measureText(next).width <= maxTextWidth) {
        current = next;
      } else {
        if (current) renderedLines.push(current);
        current = word;
      }
    });
    if (current) renderedLines.push(current);
  });

  const lineHeight = 58;
  const titleY = 92;
  const topHrY = 130;
  const bodyStartY = 190;
  const bodyHeight = renderedLines.length * lineHeight;
  const bottomHrY = bodyStartY + bodyHeight + 16;
  const thankYouY = bottomHrY + 62;
  const minHeight = 1160;
  const height = Math.max(minHeight, thankYouY + 60);

  canvas.height = height;

  // Background + outer border (screenshot style)
  ctx.fillStyle = "#efefef";
  ctx.fillRect(0, 0, width, height);
  ctx.strokeStyle = "#000000";
  ctx.lineWidth = 3;
  ctx.strokeRect(1.5, 1.5, width - 3, height - 3);

  // Title
  ctx.fillStyle = "#000000";
  ctx.textAlign = "center";
  ctx.textBaseline = "alphabetic";
  ctx.font = "bold 56px 'Courier New', monospace";
  ctx.fillText("HOSTEL STORE", width / 2, titleY);

  // Horizontal separators
  ctx.strokeStyle = "#7c7c7c";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(paddingX, topHrY);
  ctx.lineTo(width - paddingX, topHrY);
  ctx.stroke();

  // Body text
  ctx.textAlign = "left";
  ctx.font = bodyFont;
  let y = bodyStartY;
  renderedLines.forEach((line) => {
    ctx.fillText(line, paddingX, y);
    y += lineHeight;
  });

  // Footer line + text
  ctx.beginPath();
  ctx.moveTo(paddingX, bottomHrY);
  ctx.lineTo(width - paddingX, bottomHrY);
  ctx.stroke();

  ctx.textAlign = "center";
  ctx.font = "52px 'Courier New', monospace";
  ctx.fillText("Thank You", width / 2, thankYouY);

  return canvas.toDataURL("image/png");
}

function generateTextBillFallback(text, orderNo) {
  const dataUrl = buildTextBillDataUrl(text);
  triggerBillDownload(dataUrl, `bill-${orderNo}.png`);
}

function buildApiUrl(base, path) {
  return `${base.replace(/\/+$/, "")}/${String(path).replace(/^\/+/, "")}`;
}

async function apiFetch(path, options) {
  const candidates = ACTIVE_API_BASE
    ? [ACTIVE_API_BASE, ...getApiCandidates().filter((b) => b !== ACTIVE_API_BASE)]
    : getApiCandidates();

  let lastError = null;
  for (const base of candidates) {
    try {
      const res = await fetch(buildApiUrl(base, path), options);
      const ctype = (res.headers && res.headers.get && res.headers.get("content-type")) || "";
      // Wrong origin commonly returns 404/405 or HTML error page; try next candidate.
      if (res.status === 404 || res.status === 405 || res.status === 501) {
        lastError = new Error(`Route not found on ${base} (${res.status})`);
        continue;
      }
      if (!res.ok && ctype.includes("text/html")) {
        lastError = new Error(`HTML error from ${base} (${res.status})`);
        continue;
      }
      if (!res.ok && res.status >= 500) {
        lastError = new Error(`Server error from ${base} (${res.status})`);
        continue;
      }
      // For valid non-404 responses (including 4xx business errors), stop here.
      ACTIVE_API_BASE = base;
      return res;
    } catch (err) {
      lastError = err;
    }
  }
  throw lastError || new Error("API unreachable");
}

async function safeJson(res) {
  try {
    return await res.json();
  } catch (_e) {
    return {};
  }
}

function setWhatsAppManualLink(url) {
  const wrap = getById("waManualWrap");
  const link = getById("waManualLink");
  if (!wrap || !link) return;
  link.href = url;
  wrap.style.display = "block";
}

function setPaymentManualLink(url) {
  const wrap = getById("payManualWrap");
  const link = getById("payManualLink");
  if (!wrap || !link) return;
  link.href = url;
  wrap.style.display = "block";
}

function hidePaymentManualLink() {
  const wrap = getById("payManualWrap");
  if (wrap) wrap.style.display = "none";
}

function setBillManualLink(dataUrl, fileName) {
  const wrap = getById("billManualWrap");
  const link = getById("billManualLink");
  if (!wrap || !link) return;
  link.href = dataUrl;
  link.download = fileName;
  wrap.style.display = "block";
}

function escapeHtml(s) {
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getById(id) {
  return document.getElementById(id);
}

function getOrCreateDeviceId() {
  let id = localStorage.getItem(DEVICE_ID_KEY);
  if (!id) {
    id = `MM-${Math.random().toString(36).slice(2, 10).toUpperCase()}`;
    localStorage.setItem(DEVICE_ID_KEY, id);
  }
  return id;
}

function registerSecretAdminTap() {
  adminTapCount += 1;
  if (adminTapResetTimer) clearTimeout(adminTapResetTimer);
  adminTapResetTimer = setTimeout(() => {
    adminTapCount = 0;
  }, ADMIN_TAP_WINDOW_MS);

  if (adminTapCount >= ADMIN_TAP_TARGET) {
    adminTapCount = 0;
    showAdmin();
  }
}

function isSoundAllowedOnThisDevice() {
  const myId = getOrCreateDeviceId();
  const configuredIds = ORDER_ALERT_ALLOWED_DEVICE_IDS
    .map((x) => String(x || "").trim())
    .filter((x) => x && !x.includes("PUT_YOUR_"));
  let extraIds = [];
  try {
    const raw = localStorage.getItem(ALERT_ALLOWED_EXTRA_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    if (Array.isArray(parsed)) {
      extraIds = parsed.map((x) => String(x || "").trim()).filter(Boolean);
    }
  } catch (_e) {}
  const allowed = [...new Set([...configuredIds, ...extraIds])];
  if (allowed.length === 0) {
    return true;
  }
  return allowed.includes(myId);
}

function playBeepFallback() {
  try {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    const ctx = new Ctx();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.type = "sine";
    oscillator.frequency.setValueAtTime(880, ctx.currentTime);
    gainNode.gain.setValueAtTime(0.001, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.25);
  } catch (_e) {}
}

async function armSoundOnce() {
  const audio = getById("orderAlertAudio");
  if (!audio) return;
  try {
    audio.muted = true;
    await audio.play();
    audio.pause();
    audio.currentTime = 0;
    audio.muted = false;
    localStorage.setItem(SOUND_ENABLED_KEY, "1");
  } catch (_e) {}
}

async function enableOrderSound() {
  const audio = getById("orderAlertAudio");
  try {
    // User click is required once in most browsers before audio can autoplay later.
    audio.muted = true;
    await audio.play();
    audio.pause();
    audio.currentTime = 0;
    audio.muted = false;
    localStorage.setItem(SOUND_ENABLED_KEY, "1");
    const myId = getOrCreateDeviceId();
    try {
      const raw = localStorage.getItem(ALERT_ALLOWED_EXTRA_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      const list = Array.isArray(parsed) ? parsed.map((x) => String(x || "").trim()).filter(Boolean) : [];
      if (!list.includes(myId)) list.push(myId);
      localStorage.setItem(ALERT_ALLOWED_EXTRA_KEY, JSON.stringify(list));
    } catch (_e) {}
    alert(`Order alert enabled on this device.\nDevice ID: ${myId}`);
  } catch (err) {
    console.log("Audio permission not granted:", err);
    alert("Could not enable sound. Please try again and allow media/audio.");
  }
}

async function playOrderAlertIfNeeded() {
  if (!isSoundAllowedOnThisDevice()) return;
  const audio = getById("orderAlertAudio");
  if (!audio) {
    playBeepFallback();
    return;
  }
  try {
    audio.currentTime = 0;
    await audio.play();
  } catch (err) {
    console.log("Order alert play failed:", err);
    playBeepFallback();
  }
}

async function updateStoreStatus() {
  try {
    const res = await apiFetch(`/store-status?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("store-status failed");
    const data = await safeJson(res);
    storeClosed = !!data.closed;
  } catch (err) {
    console.log("Could not fetch store status:", err);
  }

  const bar = getById("storeStatus");
  const overlay = getById("closedOverlay");
  if (storeClosed) {
    bar.innerText = "STORE CLOSED";
    bar.style.background = "#f8d7da";
    bar.style.color = "#721c24";
    overlay.style.display = "block";
  } else {
    bar.innerText = "STORE OPEN";
    bar.style.background = "#d4edda";
    bar.style.color = "#155724";
    overlay.style.display = "none";
  }
}

function updateStockDisplay() {
  const lowStockItems = [];
  document.querySelectorAll(".card").forEach((card) => {
    const name = card.dataset.name;
    const tempUnavailable = String(card.dataset.tempUnavailable || "") === "true";
    const stock = Number(stockData[name] || 0);
    const btn = card.querySelector("button");
    if (tempUnavailable) {
      card.querySelector(".stock").innerText = "Temporarily Unavailable";
      btn.innerText = "Temporarily Unavailable";
      btn.style.background = "#dc3545";
      btn.dataset.out = "true";
      btn.disabled = true;
      return;
    }
    card.querySelector(".stock").innerText = stock > 0 ? `In Stock: ${stock}` : "Out of Stock";
    if (stock < LOW_STOCK_THRESHOLD) {
      lowStockItems.push(`${name} (${stock})`);
    }
    if (stock <= 0) {
      btn.innerText = "Out of Stock";
      btn.style.background = "#999";
      btn.dataset.out = "true";
      btn.disabled = true;
    } else {
      btn.innerText = "Add";
      btn.style.background = "#25d366";
      btn.dataset.out = "false";
      btn.disabled = false;
    }
  });

  const lowBox = getById("lowStockBox");
  if (lowBox) {
    lowBox.innerHTML = lowStockItems.length
      ? `Low Stock (&lt;${LOW_STOCK_THRESHOLD}):<br>${lowStockItems.map((x) => `- ${escapeHtml(x)}`).join("<br>")}`
      : "Low Stock: None";
  }
}

function getDistributorStockPayloadFromInputs() {
  return {
    "104": {
      Maggi: Number(getById("d104Maggi").value) || 0,
      Kurkure: Number(getById("d104Kurkure").value) || 0,
      Bhujia: Number(getById("d104Bhujia").value) || 0,
      Ariel: Number(getById("d104Ariel").value) || 0,
      "Bhoot Chips": Number(getById("d104BhootChips").value) || 0
    },
    "407": {
      Maggi: Number(getById("d407Maggi").value) || 0,
      Kurkure: Number(getById("d407Kurkure").value) || 0,
      Bhujia: Number(getById("d407Bhujia").value) || 0,
      Ariel: Number(getById("d407Ariel").value) || 0,
      "Bhoot Chips": Number(getById("d407BhootChips").value) || 0
    },
    "607": {
      Maggi: Number(getById("d607Maggi").value) || 0,
      Kurkure: Number(getById("d607Kurkure").value) || 0,
      Bhujia: Number(getById("d607Bhujia").value) || 0,
      Ariel: Number(getById("d607Ariel").value) || 0,
      "Bhoot Chips": Number(getById("d607BhootChips").value) || 0
    }
  };
}

function readDistributorStockCache() {
  try {
    const raw = localStorage.getItem(DISTRIBUTOR_STOCK_CACHE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (!data || typeof data !== "object") return null;
    return data;
  } catch (_err) {
    return null;
  }
}

function writeDistributorStockCache(data) {
  try {
    localStorage.setItem(DISTRIBUTOR_STOCK_CACHE_KEY, JSON.stringify(data));
  } catch (_err) {
    // ignore local cache failures
  }
}

function fillDistributorStockInputs(data) {
  const s104 = data["104"] || {};
  const s407 = data["407"] || {};
  const s607 = data["607"] || {};
  getById("d104Maggi").value = Number(s104.Maggi || 0);
  getById("d104Kurkure").value = Number(s104.Kurkure || 0);
  getById("d104Bhujia").value = Number(s104.Bhujia || 0);
  getById("d104Ariel").value = Number(s104.Ariel || 0);
  getById("d104BhootChips").value = Number(s104["Bhoot Chips"] || 0);

  getById("d407Maggi").value = Number(s407.Maggi || 0);
  getById("d407Kurkure").value = Number(s407.Kurkure || 0);
  getById("d407Bhujia").value = Number(s407.Bhujia || 0);
  getById("d407Ariel").value = Number(s407.Ariel || 0);
  getById("d407BhootChips").value = Number(s407["Bhoot Chips"] || 0);

  getById("d607Maggi").value = Number(s607.Maggi || 0);
  getById("d607Kurkure").value = Number(s607.Kurkure || 0);
  getById("d607Bhujia").value = Number(s607.Bhujia || 0);
  getById("d607Ariel").value = Number(s607.Ariel || 0);
  getById("d607BhootChips").value = Number(s607["Bhoot Chips"] || 0);
}

function renderDistributorLowStockFromData(data) {
  ["104", "407", "607"].forEach((room) => {
    const box = getById(`d${room}LowStock`);
    if (!box) return;
    const map = data[room] || {};
    const low = [];
    Object.keys(map).forEach((item) => {
      const qty = Number(map[item]) || 0;
      if (qty < DISTRIBUTOR_LOW_STOCK_THRESHOLD) {
        low.push(`${item} (${qty})`);
      }
    });
    box.innerHTML = low.length
      ? `Low Stock (&lt;${DISTRIBUTOR_LOW_STOCK_THRESHOLD}):<br>${low.map((x) => `- ${escapeHtml(x)}`).join("<br>")}`
      : "Low Stock: None";
  });
}

async function loadDistributorStock() {
  try {
    const res = await apiFetch(`/distributor-stock?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("distributor stock fetch failed");
    const data = await safeJson(res);
    writeDistributorStockCache(data || {});
    fillDistributorStockInputs(data || {});
    renderDistributorLowStockFromData(data || {});
  } catch (err) {
    console.error(err);
    const msg = String(err && err.message ? err.message : "");
    if (msg.includes("Route not found")) {
      const cached = readDistributorStockCache();
      if (cached) {
        fillDistributorStockInputs(cached);
        renderDistributorLowStockFromData(cached);
      }
    }
  }
}

function renderDistributorMonthSummary(data) {
  const month = data && data.month ? data.month : "-";
  const summary = (data && data.summary) || {};
  const s104 = summary["104"] || { ordersCount: 0, totalAmount: 0 };
  const s407 = summary["407"] || { ordersCount: 0, totalAmount: 0 };
  const s607 = summary["607"] || { ordersCount: 0, totalAmount: 0 };

  const html = [
    `<b>Distributor Monthly Totals (${escapeHtml(month)})</b>`,
    `104: Orders ${Number(s104.ordersCount) || 0}, Total Rs ${Number(s104.totalAmount) || 0}`,
    `407: Orders ${Number(s407.ordersCount) || 0}, Total Rs ${Number(s407.totalAmount) || 0}`,
    `607: Orders ${Number(s607.ordersCount) || 0}, Total Rs ${Number(s607.totalAmount) || 0}`
  ].join("<br>");
  getById("distributorMonthSummary").innerHTML = html;
}

async function loadDistributorMonthSummary() {
  try {
    const res = await apiFetch(`/distributor-month-summary?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("distributor month summary fetch failed");
    const data = await safeJson(res);
    renderDistributorMonthSummary(data || {});
  } catch (err) {
    const msg = String(err && err.message ? err.message : "");
    if (msg.includes("Route not found")) {
      // fallback from /orders
      try {
        const res2 = await apiFetch(`/orders?nocache=${Date.now()}`);
        if (!res2.ok) throw new Error("orders fallback failed");
        const orders = await safeJson(res2);
        const month = (() => {
          const d = new Date();
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        })();
        const summary = {
          "104": { ordersCount: 0, totalAmount: 0 },
          "407": { ordersCount: 0, totalAmount: 0 },
          "607": { ordersCount: 0, totalAmount: 0 }
        };
        (Array.isArray(orders) ? orders : []).forEach((o) => {
          if (o && o.status === "cancelled") return;
          const dt = o && o.createdAt ? new Date(o.createdAt) : new Date(o.time);
          if (Number.isNaN(dt.getTime())) return;
          const mk = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}`;
          if (mk !== month) return;
          const roomNum = Number(o && o.room);
          const room = Number.isFinite(roomNum) && roomNum <= 299 ? "104"
            : Number.isFinite(roomNum) && roomNum <= 599 ? "407"
            : "607";
          summary[room].ordersCount += 1;
          summary[room].totalAmount += Number(o.total) || 0;
        });
        renderDistributorMonthSummary({ month, summary });
        return;
      } catch (_e) {
        // ignore and fall through
      }
    }
    getById("distributorMonthSummary").innerText = "Distributor Monthly Totals: Could not load";
  }
}

async function saveDistributorStock() {
  try {
    const payload = getDistributorStockPayloadFromInputs();
    const res = await apiFetch("/distributor-stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await safeJson(res);
    if (!res.ok || data.status !== "saved") {
      throw new Error(data.message || "save failed");
    }
    writeDistributorStockCache(data.distributorStock || payload);
    fillDistributorStockInputs(data.distributorStock || payload);
    renderDistributorLowStockFromData(data.distributorStock || payload);
    alert("Distributor stock saved");
  } catch (err) {
    console.error(err);
    const msg = String(err && err.message ? err.message : "Unknown error");
    if (msg.includes("Route not found")) {
      const payload = getDistributorStockPayloadFromInputs();
      writeDistributorStockCache(payload);
      fillDistributorStockInputs(payload);
      renderDistributorLowStockFromData(payload);
      alert("Backend route not found (404). Distributor stock local cache me save ho gaya. Latest server.js deploy/restart karo.");
      return;
    }
    alert(`Could not save distributor stock: ${msg}`);
  }
}

function showCart() {
  if (cart.length === 0) {
    getById("cart").innerHTML = "Cart is empty";
    return;
  }
  let html = "";
  let itemsTotal = 0;
  cart.forEach((item, idx) => {
    const line = item.price * item.qty;
    itemsTotal += line;
    html += `${item.name} x${item.qty} = Rs ${line} <button onclick="removeItem(${idx})">Remove</button><br>`;
  });
  const mode = getById("mode").value;
  const deliveryCharge = getDeliveryCharge(mode);
  const grandTotal = itemsTotal + deliveryCharge;
  html += `<hr style="max-width:320px;">`;
  html += `Items Total: Rs ${itemsTotal}<br>`;
  html += `Delivery Charges: Rs ${deliveryCharge}<br>`;
  html += `<b>Grand Total: Rs ${grandTotal}</b>`;
  getById("cart").innerHTML = html;
}

function removeItem(index) {
  cart.splice(index, 1);
  showCart();
}

function addToCart(btn, _price, qtyId) {
  if (storeClosed) {
    alert("Store is closed right now");
    return;
  }

  const card = btn.closest(".card");
  const name = card.dataset.name;
  const qty = parseInt(getById(qtyId).value, 10);

  if (!Number.isInteger(qty) || qty <= 0) {
    alert("Enter valid quantity");
    return;
  }
  if (!Number.isFinite(stockData[name])) {
    alert("Product unavailable");
    return;
  }

  let alreadyInCart = 0;
  cart.forEach((item) => {
    if (item.name === name) alreadyInCart += item.qty;
  });

  const available = Number(stockData[name]) - alreadyInCart;
  if (available <= 0) {
    alert("Product is out of stock");
    return;
  }
  if (qty > available) {
    alert(`Only ${available} left`);
    return;
  }

  const found = cart.find((item) => item.name === name);
  if (found) found.qty += qty;
  else cart.push({ name, price: realPrice[name], qty });
  showCart();
}

function getDeliveryCharge(mode) {
  if (mode === "pickup") return 0;
  return 10;
}

function normalizeWhatsAppPhone(raw) {
  const digits = String(raw || "").replace(/\D/g, "");
  if (digits.length === 10) return `91${digits}`;
  return digits;
}

function buildUpiPaymentUrl(total, orderNo, customerName, roomNo) {
  const amount = Number(total || 0).toFixed(2);
  const txnNote = `Monty Mart Order ${orderNo} - ${customerName} (Room ${roomNo})`;
  return `upi://pay?pa=${encodeURIComponent(STORE_UPI_ID)}&pn=${encodeURIComponent(STORE_UPI_NAME)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(txnNote)}`;
}

function getOrderRoutingByRoom(roomNo) {
  return { collectFromRoom: "605", whatsappPhone: "9983729301" };
}

function renderDeliveryNote() {
  const mode = getById("mode").value;
  const charge = getDeliveryCharge(mode);
  getById("deliveryNote").innerText =
    mode === "pickup"
      ? "Delivery Charges: Rs 0 (Self Pickup)"
      : `Delivery Charges: Rs ${charge} (Room Delivery)`;
}

function isMobileDevice() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
}

async function generateBillImage(text, orderNo) {
  const clean = text.replace(/\n/g, "<br>");
  const fileName = `bill-${orderNo}.png`;
  const billBox = getById("billBox");

  try {
    getById("billContent").innerHTML = clean;
    billBox.style.position = "fixed";
    billBox.style.top = "50%";
    billBox.style.left = "50%";
    billBox.style.transform = "translate(-50%,-50%)";
    billBox.style.opacity = "1";

    await new Promise((resolve) => setTimeout(resolve, 300));
    if (typeof html2canvas !== "function") {
      throw new Error("html2canvas not loaded");
    }
    const canvas = await html2canvas(billBox, { backgroundColor: "#ffffff", scale: 2 });
    const dataUrl = canvas.toDataURL("image/png");
    triggerBillDownload(dataUrl, fileName);

    if (isMobileDevice()) {
      const imgWin = window.open(dataUrl, "_blank");
      if (!imgWin) {
        const wrap = getById("billManualWrap");
        if (wrap) wrap.style.display = "block";
      }
    }
  } catch (err) {
    console.warn("html2canvas bill failed, using fallback:", err);
    generateTextBillFallback(text, orderNo);
  } finally {
    billBox.style.opacity = "0";
    billBox.style.left = "-9999px";
  }
}

function updateSalesAndProfit() {}

async function placeOrder() {
  if (storeClosed) {
    alert("Store is currently closed");
    return;
  }
  if (cart.length === 0) {
    alert("Cart empty");
    return;
  }

  const name = getById("custName").value.trim();
  const room = getById("roomNo").value.trim();
  const mode = getById("mode").value;
  const paymentMode = getById("paymentMode").value;
  hidePaymentManualLink();

  if (!/^[A-Za-z ]+$/.test(name)) return alert("Invalid name");
  if (!/^[0-9]{3}$/.test(room)) return alert("Room must be exactly 3 digits");

  const items = cart.map((item) => ({
    ...item,
    price: Number(realPrice[item.name] !== undefined ? realPrice[item.name] : item.price) || 0
  }));
  const subTotal = items.reduce((sum, item) => sum + item.price * item.qty, 0);
  const deliveryCharge = getDeliveryCharge(mode);
  const total = subTotal + deliveryCharge;
  const deliveryType = mode === "pickup" ? "Self Pickup" : "Room Delivery";
  const paymentType = paymentMode === "upi" ? "UPI (Online)" : "Cash";
  const routing = getOrderRoutingByRoom(room);
  const whatsappPhone = normalizeWhatsAppPhone(routing.whatsappPhone);

  let msg = "HOSTEL STORE ORDER\n";
  msg += `Order No: ${orderCounter}\n`;
  msg += `Name: ${name}\n`;
  msg += `Room No: ${room}\n`;
  msg += `Delivery Type: ${deliveryType}\n`;
  msg += `Payment Mode: ${paymentType}\n`;
  if (mode === "pickup") {
    msg += `Collect From Room No: ${routing.collectFromRoom}\n`;
  }
  msg += "\nITEMS\n";
  items.forEach((item) => {
    msg += `${item.name} x${item.qty} = Rs ${item.price * item.qty}\n`;
  });
  msg += `\nItems Total: Rs ${subTotal}`;
  msg += `\nDelivery Charges: Rs ${deliveryCharge}`;
  msg += `\nGrand Total: Rs ${total}`;
  msg += "\nOrder cancel allowed only in 2 minutes";
  msg += "\nEstimated Time: 10-15 min";

  const payload = {
    name,
    room,
    mode,
    paymentMode,
    deliveryType,
    collectFromRoom: routing.collectFromRoom,
    assignedWhatsappPhone: whatsappPhone,
    deliveryCharge,
    items,
    total
  };

  const waUrl = `https://wa.me/${whatsappPhone}?text=${encodeURIComponent(msg)}`;
  const upiUrl = buildUpiPaymentUrl(total, orderCounter, name, room);
  const quickBillDataUrl = buildTextBillDataUrl(msg);
  const quickBillName = `bill-${orderCounter}.png`;
  setBillManualLink(quickBillDataUrl, quickBillName);
  // Try immediate download in direct click context (most reliable chance).
  triggerBillDownload(quickBillDataUrl, quickBillName);

  if (paymentMode === "upi") {
    setPaymentManualLink(upiUrl);
    // Open payment app first for UPI payments.
    const reservedPayWindow = window.open(upiUrl, "_blank");
    if (!reservedPayWindow) {
      setPaymentManualLink(upiUrl);
    }
    setWhatsAppManualLink(waUrl);
    const sendNow = confirm("Payment complete ho gaya ho to OK dabao. Uske baad WhatsApp message open hoga.");
    if (sendNow) {
      const waWindowAfterPay = window.open(waUrl, "_blank");
      if (!waWindowAfterPay) {
        setWhatsAppManualLink(waUrl);
      }
    } else {
      alert("Payment complete hone ke baad 'Tap to open WhatsApp message' se message bhej dena.");
    }
  } else {
    // Cash mode: only WhatsApp message flow.
    setWhatsAppManualLink(waUrl);
    const reservedWaWindow = window.open(waUrl, "_blank");
    if (!reservedWaWindow) {
      setWhatsAppManualLink(waUrl);
    }
  }

  try {
    const res = await apiFetch("/order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`Order save failed: ${res.status}`);
    const data = await safeJson(res);
    if (!data || data.status !== "ok" || !data.orderId) {
      throw new Error("Order save response invalid");
    }
    localStorage.setItem(LAST_ORDER_ID_KEY, String(data.orderId));
    localStorage.setItem(LAST_ORDER_TIME_KEY, String(Date.now()));
    addRecentCancelableOrder(data.orderId, Date.now());
    showCancelOrderUI();
  } catch (err) {
    console.error(err);
    alert("Could not place order on server. Please try again.");
    return;
  }

  items.forEach((item) => {
    if (Number.isFinite(stockData[item.name])) stockData[item.name] -= item.qty;
  });
  updateStockDisplay();

  localStorage.setItem("orderNo", String(++orderCounter));
  cart = [];
  showCart();

  try {
    await generateBillImage(msg, orderCounter);
  } catch (err) {
    console.log("Bill generation skipped:", err);
  }
  // WhatsApp already attempted immediately above.
}

function showAdmin() {
  if (!localStorage.getItem("adminPass")) localStorage.setItem("adminPass", "291");
  const entered = prompt("Admin password?");
  if (entered !== localStorage.getItem("adminPass")) {
    alert("Wrong password");
    return;
  }
  getById("adminPanel").style.display = "block";
  loadBuyPriceFromServer();
  loadSellPriceFromServer();
  refreshTodayReport(false);
  loadAdminCustomersReport();
  loadLifetimeCustomersReport();
}

async function saveStock() {
  stockData = {
    Maggi: +getById("sMaggi").value,
    Kurkure: +getById("sKurkure").value,
    Bhujia: +getById("sBhujia").value,
    Namkeen: +getById("sNamkeen").value,
    "Bhoot Chips": +getById("sBhootChips").value,
    "Onion Chips": +getById("sOnionChips").value,
    "Unibic Chocolate Chip Cookies": +getById("sUnibicCookies").value
  };

  updateStockDisplay();

  try {
    const res = await apiFetch("/stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(stockData)
    });
    if (!res.ok) throw new Error("Stock save failed");
    alert("Stock saved");
  } catch (err) {
    console.error(err);
    alert("Could not save stock");
  }
}

async function toggleStore() {
  try {
    const readRes = await apiFetch(`/store-status?nocache=${Date.now()}`);
    if (!readRes.ok) throw new Error("status read failed");
    const current = await readRes.json();

    const writeRes = await apiFetch("/store-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ closed: !current.closed })
    });
    if (!writeRes.ok) throw new Error("status update failed");

    await updateStoreStatus();
    alert(`Store is now ${!current.closed ? "closed" : "open"}`);
  } catch (err) {
    console.error(err);
    alert("Could not change store status");
  }
}

function showReport() {
  refreshTodayReport(true);
}

async function loadBuyPriceFromServer() {
  try {
    const res = await apiFetch(`/buy-price?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("buy price fetch failed");
    const buy = await res.json();

    getById("bMaggi").value = Number(buy.Maggi || 0);
    getById("bKurkure").value = Number(buy.Kurkure || 0);
    getById("bBhujia").value = Number(buy.Bhujia || 0);
    getById("bNamkeen").value = Number(buy.Namkeen || 0);
    getById("bBhootChips").value = Number(buy["Bhoot Chips"] || 0);
    getById("bOnionChips").value = Number(buy["Onion Chips"] || 0);
    getById("bUnibicCookies").value = Number(buy["Unibic Chocolate Chip Cookies"] || 0);
  } catch (err) {
    console.log("Could not load buy prices:", err);
  }
}

function renderSellPriceCards() {
  document.querySelectorAll(".card").forEach((card) => {
    const name = card.dataset.name;
    const priceNode = card.querySelector(".price");
    if (priceNode && Number.isFinite(Number(realPrice[name]))) {
      priceNode.innerText = `Rs ${Number(realPrice[name])}`;
    }
  });
}

async function loadSellPriceFromServer() {
  try {
    const res = await apiFetch(`/sell-price?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("sell price fetch failed");
    const sell = await res.json();
    const pick = (key, fallback) => {
      const raw = sell && Object.prototype.hasOwnProperty.call(sell, key) ? sell[key] : fallback;
      const num = Number(raw);
      return Number.isFinite(num) ? num : fallback;
    };

    realPrice = {
      ...realPrice,
      Maggi: pick("Maggi", Number(realPrice.Maggi || 20)),
      Kurkure: pick("Kurkure", Number(realPrice.Kurkure || 20)),
      Bhujia: pick("Bhujia", Number(realPrice.Bhujia || 300)),
      Namkeen: pick("Namkeen", Number(realPrice.Namkeen || 50)),
      "Bhoot Chips": pick("Bhoot Chips", Number(realPrice["Bhoot Chips"] || 20)),
      "Onion Chips": pick("Onion Chips", Number(realPrice["Onion Chips"] || 30)),
      "Unibic Chocolate Chip Cookies": pick("Unibic Chocolate Chip Cookies", Number(realPrice["Unibic Chocolate Chip Cookies"] || 30))
    };

    getById("spMaggi").value = Number(realPrice.Maggi || 0);
    getById("spKurkure").value = Number(realPrice.Kurkure || 0);
    getById("spBhujia").value = Number(realPrice.Bhujia || 0);
    getById("spNamkeen").value = Number(realPrice.Namkeen || 0);
    getById("spBhootChips").value = Number(realPrice["Bhoot Chips"] || 0);
    getById("spOnionChips").value = Number(realPrice["Onion Chips"] || 0);
    getById("spUnibicCookies").value = Number(realPrice["Unibic Chocolate Chip Cookies"] || 0);

    renderSellPriceCards();
  } catch (err) {
    console.log("Could not load sell prices:", err);
  }
}

async function saveBuyPrice() {
  const password = prompt("Enter password to update BUY prices");
  if (password === null) return;
  const buy = {
    Maggi: +getById("bMaggi").value,
    Kurkure: +getById("bKurkure").value,
    Bhujia: +getById("bBhujia").value,
    Namkeen: +getById("bNamkeen").value,
    "Bhoot Chips": +getById("bBhootChips").value,
    "Onion Chips": +getById("bOnionChips").value,
    "Unibic Chocolate Chip Cookies": +getById("bUnibicCookies").value
  };
  try {
    const res = await apiFetch("/buy-price", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: password.trim(), prices: buy })
    });
    const data = await safeJson(res);
    if (!res.ok || data.status !== "saved") throw new Error(data.message || "buy price save failed");
    alert("Buy price saved");
    refreshTodayReport(false);
  } catch (err) {
    console.error(err);
    alert(`Could not save buy price: ${err.message || "Unknown error"}`);
  }
}

async function saveSellPrice() {
  const password = prompt("Enter password to update SELL prices");
  if (password === null) return;
  const sell = {
    Maggi: +getById("spMaggi").value,
    Kurkure: +getById("spKurkure").value,
    Bhujia: +getById("spBhujia").value,
    Namkeen: +getById("spNamkeen").value,
    "Bhoot Chips": +getById("spBhootChips").value,
    "Onion Chips": +getById("spOnionChips").value,
    "Unibic Chocolate Chip Cookies": +getById("spUnibicCookies").value
  };
  try {
    const res = await apiFetch("/sell-price", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: password.trim(), prices: sell })
    });
    const data = await safeJson(res);
    if (!res.ok || data.status !== "saved") throw new Error(data.message || "sell price save failed");
    realPrice = { ...realPrice, ...sell };
    renderSellPriceCards();
    alert("Sell price saved");
    refreshTodayReport(false);
  } catch (err) {
    console.error(err);
    alert(`Could not save sell price: ${err.message || "Unknown error"}`);
  }
}

async function refreshTodayReport(showPopup) {
  try {
    const res = await apiFetch(`/today-report?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("today report fetch failed");
    const data = await safeJson(res);

    getById("earningsBox").innerText = `Today Earnings: Rs ${data.revenue || 0}`;
    getById("monthEarningsBox").innerText = `This Month Earning: Rs ${data.monthRevenue || 0}`;
    getById("profitBox").innerText = `Today Profit: Rs ${data.profit || 0}`;
    getById("monthProfitBox").innerText = `This Month Profit: Rs ${data.monthProfit || 0}`;

    if (!showPopup) return;

    let text = "TODAY REPORT\n\n";
    const items = data.items || {};
    const keys = Object.keys(items);
    if (keys.length === 0) {
      text += "No sales today\n";
    } else {
      keys.forEach((item) => {
        text += `${item} x ${items[item]}\n`;
      });
    }
    text += `\nOrders: ${data.ordersCount || 0}`;
    text += `\nRevenue Rs ${data.revenue || 0}`;
    text += `\nProfit Rs ${data.profit || 0}`;
    text += `\nMonth Revenue Rs ${data.monthRevenue || 0}`;
    text += `\nMonth Profit Rs ${data.monthProfit || 0}`;
    alert(text);
  } catch (err) {
    console.error(err);
    if (showPopup) alert("Could not load today's report");
  }
}

async function loadOrders() {
  try {
    const res = await apiFetch(`/orders?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("orders fetch failed");
    const orders = await res.json();
    const allOrders = Array.isArray(orders) ? orders : [];

    const newestOrder = allOrders.length ? allOrders[allOrders.length - 1] : null;
    const newestOrderId = newestOrder ? Number(newestOrder.id || 0) : 0;
    const isNewById = lastSeenOrderId !== null && newestOrderId > lastSeenOrderId;
    const isNewByCount = lastSeenOrderCount > 0 && allOrders.length > lastSeenOrderCount;

    if (isNewById || (newestOrderId === 0 && isNewByCount)) {
      playOrderAlertIfNeeded();
    }

    if (newestOrderId > 0) lastSeenOrderId = newestOrderId;
    lastSeenOrderCount = allOrders.length;

    function orderCardHtml(o) {
      const orderStatus = o.status === "cancelled" ? "Cancelled" : (o.status === "accepted" ? "Accepted" : "Active");
      const statusColor = o.status === "cancelled" ? "#d9534f" : (o.status === "accepted" ? "#0d6efd" : "#198754");
      const orderId = Number(o && o.id) || 0;
      const items = Array.isArray(o.items) ? o.items : [];
      const itemRows = items.map((i) => {
        const qty = Number(i.qty) || 0;
        const price = Number(i.price) || 0;
        const lineTotal = qty * price;
        return `${i.name} x${qty} = Rs ${lineTotal}`;
      }).join("<br>");
      const itemsTotal = items.reduce((sum, i) => sum + ((Number(i.qty) || 0) * (Number(i.price) || 0)), 0);
      const deliveryCharge = Number(o.deliveryCharge) || 0;
      const grandTotal = Number(o.total) || (itemsTotal + deliveryCharge);
      return `
<div style="border:1px solid #aaa;padding:8px;margin:5px;">
<b>${o.name}</b> (Room ${o.room})<br>
Order No: ${orderId || "-"}<br>
Type: <b>${o.mode === "pickup" ? "Self Pickup" : "Room Delivery"}</b><br>
Status: <b style="color:${statusColor};">${orderStatus}</b><br>
Items:<br>
${itemRows || "No items"}<br>
Items Total: Rs ${itemsTotal}<br>
Delivery: Rs ${deliveryCharge}<br>
Grand Total: Rs ${grandTotal}<br>
${(o.status !== "cancelled" && orderId > 0) ? `<button class="btn" style="background:#ff3b3b;padding:6px 10px;margin-top:6px;" onclick="adminQuickCancelOrder(${orderId})">Quick Cancel</button><br>` : ""}
<small>${o.time}</small>
</div>
`;
    }

    const latestOrders = allOrders.slice().reverse().slice(0, LIVE_ORDERS_PER_FLOOR_LIMIT);
    let html = `<h3>Live Orders (6th Floor Dispatch) (${latestOrders.length}/${allOrders.length})</h3>`;
    html += `<div class="floorCol"><div class="floorMeta">Collect from Room 605 | WhatsApp: 9983729301</div><div class="floorOrdersList">${latestOrders.length ? latestOrders.map(orderCardHtml).join("") : "<div>No orders</div>"}</div></div>`;
    getById("liveOrders").innerHTML = html;
  } catch (err) {
    console.error(err);
    getById("liveOrders").innerHTML = "<h3>Live Orders</h3><div>Could not load orders</div>";
  }
}

async function loadStockFromServer() {
  try {
    const res = await apiFetch(`/stock?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("stock fetch failed");
    stockData = await res.json();
    updateStockDisplay();
  } catch (err) {
    console.log("Server offline, keeping current stock cache:", err);
  }
}

function showCancelOrderUI() {
  const wrap = getById("cancelOrderWrap");
  const timerText = getById("cancelTimerText");
  const listBox = getById("cancelOrdersList");
  const activeOrders = getActiveCancelableOrders();

  if (cancelUiTimer) {
    clearTimeout(cancelUiTimer);
    cancelUiTimer = null;
  }

  if (!activeOrders.length) {
    wrap.style.display = "none";
    if (listBox) listBox.innerHTML = "";
    if (timerText) timerText.innerText = "";
    localStorage.removeItem(LAST_ORDER_ID_KEY);
    localStorage.removeItem(LAST_ORDER_TIME_KEY);
    return;
  }

  wrap.style.display = "block";
  if (listBox) {
    listBox.innerHTML = activeOrders.map((o) => {
      const leftSec = Math.max(0, Math.ceil((CANCEL_WINDOW_MS - (Date.now() - o.time)) / 1000));
      return `<button class="btn" style="background:#ff3b3b;margin:4px 3px;padding:7px 10px;" onclick="cancelMyOrder(${o.id})">Cancel #${o.id} (${leftSec}s)</button>`;
    }).join("");
  }

  const nearestExpiryMs = Math.max(0, CANCEL_WINDOW_MS - (Date.now() - activeOrders[activeOrders.length - 1].time));
  const nearestSec = Math.ceil(nearestExpiryMs / 1000);
  if (timerText) timerText.innerText = `Last 2 minutes ke orders cancel ho sakte hain (${nearestSec}s left)`;
  cancelUiTimer = setTimeout(showCancelOrderUI, 1000);
}

async function cancelMyOrder(orderIdArg) {
  const orderId = Number(orderIdArg || 0);
  if (!orderId) {
    alert("No recent order found");
    return;
  }
  const activeOrders = getActiveCancelableOrders();
  const found = activeOrders.find((o) => o.id === orderId);
  if (!found) {
    alert("Cancel window expired (2 min)");
    showCancelOrderUI();
    return;
  }

  const ok = confirm(`Order No ${orderId} cancel karna hai?`);
  if (!ok) return;

  try {
    const res = await apiFetch("/cancel-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId, confirmOrderId: orderId })
    });
    const data = await safeJson(res);
    if (!res.ok || data.status !== "cancelled") {
      throw new Error(data.message || data.status || "Cancel failed");
    }
    alert(`Order #${orderId} cancelled successfully`);
    removeRecentCancelableOrder(orderId);
    const activeAfter = getActiveCancelableOrders();
    if (!activeAfter.length) {
      localStorage.removeItem(LAST_ORDER_ID_KEY);
      localStorage.removeItem(LAST_ORDER_TIME_KEY);
    } else {
      localStorage.setItem(LAST_ORDER_ID_KEY, String(activeAfter[0].id));
      localStorage.setItem(LAST_ORDER_TIME_KEY, String(activeAfter[0].time));
    }
    showCancelOrderUI();
    loadOrders();
    loadStockFromServer();
    refreshTodayReport(false);
    loadTopCustomers();
    if (getById("adminPanel").style.display === "block") {
      loadAdminCustomersReport();
    }
  } catch (err) {
    console.error(err);
    alert(`Could not cancel order: ${err.message || "Unknown error"}`);
  }
}

async function adminQuickCancelOrder(orderIdArg) {
  const orderId = Number(orderIdArg || 0);
  if (!orderId) {
    alert("Invalid order id");
    return;
  }
  const ok = confirm(`Admin quick cancel: Order #${orderId}?`);
  if (!ok) return;
  try {
    const res = await apiFetch("/cancel-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId, confirmOrderId: orderId })
    });
    const data = await safeJson(res);
    if (!res.ok || data.status !== "cancelled") {
      throw new Error(data.message || data.status || "Cancel failed");
    }
    removeRecentCancelableOrder(orderId);
    showCancelOrderUI();
    loadOrders();
    loadStockFromServer();
    refreshTodayReport(false);
    loadTopCustomers();
    if (getById("adminPanel").style.display === "block") {
      loadAdminCustomersReport();
    }
    alert(`Order #${orderId} cancelled by admin`);
  } catch (err) {
    console.error(err);
    alert(`Admin cancel failed: ${err.message || "Unknown error"}`);
  }
}

async function adminUpdateOrderStatus(orderId, action) {
  if (action === "cancel") {
    await adminQuickCancelOrder(orderId);
    return;
  }
  alert("Only cancel action is enabled.");
}

async function loadTopCustomers() {
  function monthKey(dateObj) {
    return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, "0")}`;
  }
  function orderDate(order) {
    const d1 = order && order.createdAt ? new Date(order.createdAt) : null;
    if (d1 && !Number.isNaN(d1.getTime())) return d1;
    const d2 = order && order.time ? new Date(order.time) : null;
    if (d2 && !Number.isNaN(d2.getTime())) return d2;
    return null;
  }
  function renderTop(data) {
    const top = Array.isArray(data.topCustomers) ? data.topCustomers : [];
    if (top.length === 0) {
      getById("topCustomersBox").innerText = "Top 3 Customers (This Month): No orders yet";
      return;
    }
    const lines = top
      .map((c, idx) => `${idx + 1}) ${escapeHtml(c.name)} (Room ${escapeHtml(c.room)}) - Rs ${Number(c.totalSpent) || 0}`)
      .join("<br>");
    getById("topCustomersBox").innerHTML = `Top 3 Customers (${escapeHtml(data.month)}):<br>${lines}`;
  }

  try {
    const res = await apiFetch(`/top-customers?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("top customers fetch failed");
    const data = await res.json();
    renderTop(data);
  } catch (err) {
    console.warn("top-customers API failed, using orders fallback:", err);
    try {
      const res2 = await apiFetch(`/orders?nocache=${Date.now()}`);
      if (!res2.ok) throw new Error("orders fallback failed");
      const orders = await res2.json();
      const month = monthKey(new Date());
      const spendMap = {};
      (Array.isArray(orders) ? orders : []).forEach((o) => {
        if (o && o.status === "cancelled") return;
        if (o && o.excludeFromCustomerStats === true) return;
        const dt = orderDate(o);
        if (!dt || monthKey(dt) !== month) return;
        const key = `${String(o.name || "").trim()}|${String(o.room || "").trim()}`;
        if (!spendMap[key]) {
          spendMap[key] = {
            name: String(o.name || "").trim() || "Unknown",
            room: String(o.room || "").trim() || "-",
            totalSpent: 0
          };
        }
        spendMap[key].totalSpent += Number(o.total) || 0;
      });
      const topCustomers = Object.values(spendMap)
        .sort((a, b) => b.totalSpent - a.totalSpent)
        .slice(0, 3);
      renderTop({ month, topCustomers });
    } catch (err2) {
      console.error("Top customers fallback also failed:", err2);
      getById("topCustomersBox").innerText = "Top 3 Customers (This Month): Could not load";
    }
  }
}

async function loadAdminCustomersReport() {
  try {
    const res = await apiFetch(`/customers-report?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("customers report fetch failed");
    const data = await res.json();
    const activeCustomers = Array.isArray(data.customers) ? data.customers : [];
    const allCustomers = Array.isArray(data.allCustomers) ? data.allCustomers : activeCustomers;
    const source = activeCustomers.length ? activeCustomers : allCustomers;
    const customers = source.slice(0, 100);
    const totalCustomers = Number(data.totalCustomers);
    const activeCount = Number(data.activeCustomersCount);

    if (customers.length === 0) {
      getById("adminCustomersReport").innerHTML = `<div>No customers found for ${data.month || "-"}</div>`;
      return;
    }
    let html = `<div><b>Month:</b> ${data.month}</div>`;
    html += `<div><b>Total Customers:</b> ${Number.isFinite(totalCustomers) ? totalCustomers : allCustomers.length} | <b>Active Customers:</b> ${Number.isFinite(activeCount) ? activeCount : activeCustomers.length} | <b>Showing:</b> ${customers.length} (max 100)</div>`;
    if (activeCustomers.length === 0 && allCustomers.length > 0) {
      html += `<div style="font-size:12px;color:#666;margin-top:4px;">Note: Active customers 0 hai kyunki month stats reset/excluded ho chuki hain. List all customers ki dikh rahi hai.</div>`;
    }
    html += `<table style="width:100%;border-collapse:collapse;margin-top:6px;">
<tr><th style="border:1px solid #ccc;padding:6px;">#</th><th style="border:1px solid #ccc;padding:6px;">Name</th><th style="border:1px solid #ccc;padding:6px;">Room</th><th style="border:1px solid #ccc;padding:6px;">Orders</th><th style="border:1px solid #ccc;padding:6px;">Spent</th></tr>`;
    customers.forEach((c, idx) => {
      html += `<tr>
<td style="border:1px solid #ccc;padding:6px;">${idx + 1}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.name}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.room}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.ordersCount}</td>
<td style="border:1px solid #ccc;padding:6px;">Rs ${c.totalSpent}</td>
</tr>`;
    });
    html += "</table>";
    getById("adminCustomersReport").innerHTML = html;
  } catch (err) {
    console.error(err);
    getById("adminCustomersReport").innerHTML = "<div>Could not load customer report</div>";
  }
}

async function resetCustomerMoney() {
  const pass = prompt("Enter reset password");
  if (pass === null) return;
  if (!pass.trim()) {
    alert("Password required");
    return;
  }

  try {
    const payload = {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pass.trim() })
    };

    let res = await apiFetch("/admin/reset-customer-money", payload);
    let data = await safeJson(res);

    if ((res.status === 404 || data.status === "not_found") && !res.ok) {
      // Compatibility fallback if backend exposes non-admin path.
      res = await apiFetch("/reset-customer-money", payload);
      data = await safeJson(res);
    }

    if (!res.ok || data.status !== "reset") {
      throw new Error(data.message || data.status || "Reset failed");
    }
    alert(`Customer money reset done for ${data.month}. Affected orders: ${data.affected}`);
    loadTopCustomers();
    loadAdminCustomersReport();
    loadLifetimeCustomersReport();
  } catch (err) {
    console.error(err);
    const msg = String(err.message || "Unknown error");
    if (msg.includes("Route not found")) {
      alert("Reset route not found on current backend. Please restart/deploy latest server.js, then try again.");
      return;
    }
    alert(`Could not reset customer money: ${msg}`);
  }
}

async function resetProfitTotals() {
  const pass = prompt("Enter reset password for profit");
  if (pass === null) return;
  if (!pass.trim()) {
    alert("Password required");
    return;
  }

  try {
    const payload = {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pass.trim() })
    };

    let res = await apiFetch("/admin/reset-profit", payload);
    let data = await safeJson(res);

    if ((res.status === 404 || data.status === "not_found") && !res.ok) {
      // Compatibility fallback if backend exposes non-admin path.
      res = await apiFetch("/reset-profit", payload);
      data = await safeJson(res);
    }

    if (!res.ok || data.status !== "reset") {
      throw new Error(data.message || data.status || "Reset profit failed");
    }
    alert(`Profit reset done for ${data.month}. Affected orders: ${data.affected}`);
    refreshTodayReport(false);
  } catch (err) {
    console.error(err);
    const msg = String(err.message || "Unknown error");
    if (msg.includes("Route not found")) {
      alert("Reset profit route not found on current backend. Please restart/deploy latest server.js, then try again.");
      return;
    }
    alert(`Could not reset profit: ${msg}`);
  }
}

async function loadLifetimeCustomersReport() {
  try {
    const res = await apiFetch(`/customers-lifetime?nocache=${Date.now()}`);
    if (!res.ok) throw new Error("lifetime customers fetch failed");
    const data = await res.json();
    const allCustomers = Array.isArray(data.customers) ? data.customers : [];
    const customers = allCustomers.slice(0, 200);
    if (customers.length === 0) {
      getById("lifetimeCustomersReport").innerHTML = "<div>No lifetime customer data found yet</div>";
      return;
    }
    let html = `<div><b>Total Customers (All Time):</b> ${Number(data.totalCustomers) || allCustomers.length}</div>`;
    html += `<div><b>Showing:</b> ${customers.length} (max 200)</div>`;
    html += `<table style="width:100%;border-collapse:collapse;margin-top:6px;">
<tr><th style="border:1px solid #ccc;padding:6px;">#</th><th style="border:1px solid #ccc;padding:6px;">Name</th><th style="border:1px solid #ccc;padding:6px;">Room</th><th style="border:1px solid #ccc;padding:6px;">Orders</th><th style="border:1px solid #ccc;padding:6px;">Total</th></tr>`;
    customers.forEach((c, idx) => {
      html += `<tr>
<td style="border:1px solid #ccc;padding:6px;">${idx + 1}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.name}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.room}</td>
<td style="border:1px solid #ccc;padding:6px;">${c.ordersCount}</td>
<td style="border:1px solid #ccc;padding:6px;">Rs ${c.totalSpent}</td>
</tr>`;
    });
    html += "</table>";
    getById("lifetimeCustomersReport").innerHTML = html;
  } catch (err) {
    console.error(err);
    getById("lifetimeCustomersReport").innerHTML = "<div>Could not load lifetime customer report</div>";
  }
}

getById("mode").addEventListener("change", () => {
  renderDeliveryNote();
  showCart();
});
getById("roomNo").addEventListener("input", (e) => {
  const clean = String(e.target.value || "").replace(/\D/g, "").slice(0, 3);
  e.target.value = clean;
});
getById("deviceIdBox").innerText = getOrCreateDeviceId();
getById("storeHeader").addEventListener("click", registerSecretAdminTap);
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.shiftKey && String(e.key || "").toLowerCase() === "a") {
    showAdmin();
  }
});
document.addEventListener("click", armSoundOnce, { once: true });
document.addEventListener("touchstart", armSoundOnce, { once: true });
showCart();
renderDeliveryNote();
updateStoreStatus();
setInterval(updateStoreStatus, 5000);
loadStockFromServer();
setInterval(loadStockFromServer, 15000);
loadSellPriceFromServer();
loadOrders();
setInterval(loadOrders, 5000);
refreshTodayReport(false);
setInterval(() => refreshTodayReport(false), 15000);
loadTopCustomers();
setInterval(loadTopCustomers, 15000);
showCancelOrderUI();
</script>

</body>
</html>
